name: ç¼–è¯‘ SkyMenus (é™æ€é“¾æ¥ç‰ˆ)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    name: ç¼–è¯‘ iOS dylib (åŒ…å« JRMemory)
    runs-on: macos-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: æ£€æŸ¥æ–‡ä»¶ç»“æ„
      run: |
        echo "=== é¡¹ç›®æ–‡ä»¶ ==="
        ls -la
        echo ""
        echo "=== JRMemory.framework ç»“æ„ ==="
        ls -laR Frameworks/JRMemory.framework/
        echo ""
        echo "=== æ£€æŸ¥ JRMemory ç±»å‹ ==="
        file Frameworks/JRMemory.framework/JRMemory
    
    - name: è®¾ç½® Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: å®‰è£…ç­¾åå·¥å…·
      run: brew install ldid
    
    - name: ä¿®å¤å¤´æ–‡ä»¶å¼•ç”¨
      run: |
        echo "ä¿®å¤ metalbiew.mm ä¸­çš„å¤´æ–‡ä»¶å¼•ç”¨..."
        sed -i '' 's/#include <JRMemory\/MemScan.h>/#include "MemScan.h"/g' metalbiew.mm
        echo "âœ“ å·²ä¿®å¤"
    
    - name: ç¼–è¯‘æºæ–‡ä»¶
      run: |
        SDK=$(xcrun --sdk iphoneos --show-sdk-path)
        mkdir -p build
        
        HEADERS="-I./Frameworks/JRMemory.framework/Headers"
        
        echo "[1/8] ViewController.mm"
        xcrun clang++ -arch arm64 -isysroot "$SDK" -miphoneos-version-min=10.0 \
          -fobjc-arc -std=c++11 $HEADERS -I./imgui -I. \
          -c ViewController.mm -o build/ViewController.o
        
        echo "[2/8] metalbiew.mm"
        xcrun clang++ -arch arm64 -isysroot "$SDK" -miphoneos-version-min=10.0 \
          -fobjc-arc -std=c++11 $HEADERS -I./imgui -I. \
          -c metalbiew.mm -o build/metalbiew.o
        
        echo "[3/8] DragView.m"
        xcrun clang -arch arm64 -isysroot "$SDK" -miphoneos-version-min=10.0 \
          -fobjc-arc -I. \
          -c DragView.m -o build/DragView.o
        
        echo "[4/8] imgui.cpp"
        xcrun clang++ -arch arm64 -isysroot "$SDK" -miphoneos-version-min=10.0 \
          -std=c++11 -I./imgui \
          -c imgui/imgui.cpp -o build/imgui.o
        
        echo "[5/8] imgui_draw.cpp"
        xcrun clang++ -arch arm64 -isysroot "$SDK" -miphoneos-version-min=10.0 \
          -std=c++11 -I./imgui \
          -c imgui/imgui_draw.cpp -o build/imgui_draw.o
        
        echo "[6/8] imgui_widgets.cpp"
        xcrun clang++ -arch arm64 -isysroot "$SDK" -miphoneos-version-min=10.0 \
          -std=c++11 -I./imgui \
          -c imgui/imgui_widgets.cpp -o build/imgui_widgets.o
        
        echo "[7/8] imgui_tables.cpp"
        xcrun clang++ -arch arm64 -isysroot "$SDK" -miphoneos-version-min=10.0 \
          -std=c++11 -I./imgui \
          -c imgui/imgui_tables.cpp -o build/imgui_tables.o
        
        echo "[8/8] imgui_impl_metal.mm"
        xcrun clang++ -arch arm64 -isysroot "$SDK" -miphoneos-version-min=10.0 \
          -fobjc-arc -std=c++11 -I./imgui \
          -c imgui/imgui_impl_metal.mm -o build/imgui_impl_metal.o
    
    - name: é“¾æ¥åŠ¨æ€åº“ (é™æ€é“¾æ¥ JRMemory)
      run: |
        SDK=$(xcrun --sdk iphoneos --show-sdk-path)
        
        echo "=== é™æ€é“¾æ¥ JRMemory åˆ° SkyMenus.dylib ==="
        echo "è¿™æ ·å°±ä¸éœ€è¦å•ç‹¬çš„ JRMemory.framework äº†ï¼"
        echo ""
        
        xcrun clang++ -arch arm64 -isysroot "$SDK" \
          -dynamiclib \
          -install_name "@rpath/SkyMenus.dylib" \
          -Xlinker -rpath -Xlinker "@executable_path/Frameworks" \
          -framework UIKit \
          -framework Foundation \
          -framework Metal \
          -framework MetalKit \
          -framework CoreGraphics \
          -lc++ \
          build/*.o \
          Frameworks/JRMemory.framework/JRMemory \
          -o SkyMenus.dylib
        
        echo ""
        echo "âœ“ é“¾æ¥å®Œæˆï¼JRMemory å·²åŒ…å«åœ¨ SkyMenus.dylib ä¸­"
    
    - name: ç­¾å
      run: ldid -S SkyMenus.dylib
    
    - name: éªŒè¯æ–‡ä»¶
      run: |
        echo "=== æ–‡ä»¶ä¿¡æ¯ ==="
        ls -lh SkyMenus.dylib
        file SkyMenus.dylib
        echo ""
        echo "=== æ¶æ„ ==="
        lipo -info SkyMenus.dylib
        echo ""
        echo "=== ä¾èµ–åº“ ==="
        otool -L SkyMenus.dylib
        echo ""
        echo "=== ç¬¦å·æ£€æŸ¥ ==="
        nm -g SkyMenus.dylib | grep -i "jrmemory" | head -10 || echo "JRMemory ç¬¦å·å·²é™æ€é“¾æ¥"
    
    - name: åˆ›å»ºè¯´æ˜æ–‡ä»¶
      run: |
        cat > README.txt << 'EOF'
        â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
        â•‘         SkyMenus.dylib - é™æ€é“¾æ¥ç‰ˆ                           â•‘
        â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        æœ¬ç‰ˆæœ¬å·²å°† JRMemory é™æ€é“¾æ¥åˆ° SkyMenus.dylib ä¸­
        
        âœ… ä¼˜ç‚¹:
        - åªéœ€è¦ä¸€ä¸ªæ–‡ä»¶: SkyMenus.dylib
        - ä¸éœ€è¦å•ç‹¬çš„ JRMemory.framework
        - å…¨èƒ½ç­¾å¯ä»¥ç›´æ¥è¯†åˆ«
        - å®‰è£…æ›´ç®€å•
        
        ğŸ“¦ å…¨èƒ½ç­¾ä½¿ç”¨æ–¹æ³•:
        
        1. æ‰“å¼€å…¨èƒ½ç­¾
        2. å¯¼å…¥æ¸¸æˆ IPA
        3. åŠ¨æ€åº“æ³¨å…¥è®¾ç½®:
           - æ³¨å…¥è·¯å¾„: â˜‘ @executable
           - æ³¨å…¥ç›®å½•: Frameworks/
        4. æ·»åŠ ç¬¬ä¸‰æ–¹åº“:
           - åªæ·»åŠ è¿™ä¸€ä¸ªæ–‡ä»¶: SkyMenus.dylib
        5. é€‰æ‹©è¯ä¹¦å¹¶ç­¾å
        6. å®‰è£…åˆ°è®¾å¤‡
        
        ğŸ® ä½¿ç”¨æ–¹æ³•:
        
        1. å¯åŠ¨æ¸¸æˆï¼Œç­‰å¾… 3-5 ç§’
        2. ä¸‰æŒ‡ä¸‰å‡»å±å¹•æ˜¾ç¤º/éšè—å›¾æ ‡
        3. å•å‡»å›¾æ ‡æ‰“å¼€èœå•
        4. é¦–æ¬¡ä½¿ç”¨ç‚¹å‡»"åˆå§‹åŒ–"
        
        âš ï¸ æ³¨æ„:
        - æ¸¸æˆç‰ˆæœ¬: 0.15.3
        - ä¸è¦ä¿®æ”¹ Bundle ID
        - å»ºè®®ç”¨å°å·æµ‹è¯•
        
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        ç¼–è¯‘æ—¶é—´: $(date)
        ç‰ˆæœ¬: é™æ€é“¾æ¥ç‰ˆ
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        EOF
        
        cat README.txt
    
    - name: ä¸Šä¼ æ–‡ä»¶
      uses: actions/upload-artifact@v4
      with:
        name: SkyMenus-Static
        path: |
          SkyMenus.dylib
          README.txt
