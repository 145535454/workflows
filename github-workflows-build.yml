name: ç¼–è¯‘ SkyMenus.dylib

on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  
  # æˆ–åœ¨æ¨é€æ—¶è‡ªåŠ¨ç¼–è¯‘
  push:
    branches: [ main, master ]
    paths:
      - '**.mm'
      - '**.m'
      - '**.cpp'
      - '**.h'

jobs:
  build-ios-dylib:
    name: ç¼–è¯‘ iOS åŠ¨æ€åº“
    runs-on: macos-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
    
    - name: ğŸ” æ£€æŸ¥æ–‡ä»¶
      run: |
        echo "æ£€æŸ¥é¡¹ç›®æ–‡ä»¶..."
        ls -la
        echo ""
        echo "æ£€æŸ¥ imgui ç›®å½•..."
        ls -la imgui/ || echo "è­¦å‘Š: imgui ç›®å½•ä¸å­˜åœ¨"
        echo ""
        echo "æ£€æŸ¥ Frameworks ç›®å½•..."
        ls -la Frameworks/ || echo "è­¦å‘Š: Frameworks ç›®å½•ä¸å­˜åœ¨"
    
    - name: ğŸ› ï¸ è®¾ç½® Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: ğŸ“¦ å®‰è£…å·¥å…·
      run: |
        # å®‰è£… ldid ç”¨äºä»£ç ç­¾å
        brew install ldid
        
        echo "å·¥å…·ç‰ˆæœ¬ä¿¡æ¯:"
        xcrun --version
        clang --version
        ldid -V
    
    - name: ğŸ”¨ ç¼–è¯‘ SkyMenus.dylib
      run: |
        echo "å¼€å§‹ç¼–è¯‘..."
        
        # è®¾ç½®å˜é‡
        SDK_PATH=$(xcrun --sdk iphoneos --show-sdk-path)
        OUTPUT="SkyMenus.dylib"
        
        echo "SDK è·¯å¾„: $SDK_PATH"
        
        # åˆ›å»ºä¸´æ—¶ç›®å½•
        mkdir -p build/obj
        
        # ç¼–è¯‘æºæ–‡ä»¶
        echo "[1/8] ç¼–è¯‘ ViewController.mm..."
        xcrun clang++ -arch arm64 -isysroot "$SDK_PATH" \
          -miphoneos-version-min=10.0 -fobjc-arc -std=c++11 \
          -I./imgui -I. \
          -c ViewController.mm -o build/obj/ViewController.o
        
        echo "[2/8] ç¼–è¯‘ metalbiew.mm..."
        xcrun clang++ -arch arm64 -isysroot "$SDK_PATH" \
          -miphoneos-version-min=10.0 -fobjc-arc -std=c++11 \
          -I./imgui -I. \
          -c metalbiew.mm -o build/obj/metalbiew.o
        
        echo "[3/8] ç¼–è¯‘ DragView.m..."
        xcrun clang -arch arm64 -isysroot "$SDK_PATH" \
          -miphoneos-version-min=10.0 -fobjc-arc \
          -I. \
          -c DragView.m -o build/obj/DragView.o
        
        echo "[4/8] ç¼–è¯‘ imgui.cpp..."
        xcrun clang++ -arch arm64 -isysroot "$SDK_PATH" \
          -miphoneos-version-min=10.0 -std=c++11 \
          -I./imgui \
          -c imgui/imgui.cpp -o build/obj/imgui.o
        
        echo "[5/8] ç¼–è¯‘ imgui_draw.cpp..."
        xcrun clang++ -arch arm64 -isysroot "$SDK_PATH" \
          -miphoneos-version-min=10.0 -std=c++11 \
          -I./imgui \
          -c imgui/imgui_draw.cpp -o build/obj/imgui_draw.o
        
        echo "[6/8] ç¼–è¯‘ imgui_widgets.cpp..."
        xcrun clang++ -arch arm64 -isysroot "$SDK_PATH" \
          -miphoneos-version-min=10.0 -std=c++11 \
          -I./imgui \
          -c imgui/imgui_widgets.cpp -o build/obj/imgui_widgets.o
        
        echo "[7/8] ç¼–è¯‘ imgui_tables.cpp..."
        xcrun clang++ -arch arm64 -isysroot "$SDK_PATH" \
          -miphoneos-version-min=10.0 -std=c++11 \
          -I./imgui \
          -c imgui/imgui_tables.cpp -o build/obj/imgui_tables.o
        
        echo "[8/8] ç¼–è¯‘ imgui_impl_metal.mm..."
        xcrun clang++ -arch arm64 -isysroot "$SDK_PATH" \
          -miphoneos-version-min=10.0 -fobjc-arc -std=c++11 \
          -I./imgui \
          -c imgui/imgui_impl_metal.mm -o build/obj/imgui_impl_metal.o
        
        echo ""
        echo "é“¾æ¥åŠ¨æ€åº“..."
        xcrun clang++ -arch arm64 -isysroot "$SDK_PATH" \
          -dynamiclib \
          -install_name "@rpath/SkyMenus.dylib" \
          -Xlinker -rpath -Xlinker "@executable_path/Frameworks" \
          -framework UIKit \
          -framework Foundation \
          -framework Metal \
          -framework MetalKit \
          -framework CoreGraphics \
          -F./Frameworks \
          -framework JRMemory \
          build/obj/*.o \
          -o "$OUTPUT"
        
        echo ""
        echo "âœ… ç¼–è¯‘å®Œæˆï¼"
    
    - name: ğŸ” ä»£ç ç­¾å
      run: |
        echo "ä½¿ç”¨ ldid ç­¾å..."
        ldid -S SkyMenus.dylib
        
        echo "ç­¾åå®Œæˆï¼"
    
    - name: ğŸ“Š éªŒè¯æ–‡ä»¶
      run: |
        echo "æ–‡ä»¶ä¿¡æ¯:"
        ls -lh SkyMenus.dylib
        file SkyMenus.dylib
        
        echo ""
        echo "æ¶æ„ä¿¡æ¯:"
        lipo -info SkyMenus.dylib
        
        echo ""
        echo "ä¾èµ–åº“:"
        otool -L SkyMenus.dylib
    
    - name: ğŸ“¤ ä¸Šä¼ ç¼–è¯‘äº§ç‰©
      uses: actions/upload-artifact@v3
      with:
        name: SkyMenus-dylib
        path: |
          SkyMenus.dylib
          Frameworks/JRMemory.framework/
        retention-days: 30
    
    - name: ğŸ“ åˆ›å»º Releaseï¼ˆå¯é€‰ï¼‰
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v1.0-${{ github.run_number }}
        name: SkyMenus v1.0 Build ${{ github.run_number }}
        body: |
          è‡ªåŠ¨ç¼–è¯‘çš„ SkyMenus.dylib
          
          **ä½¿ç”¨æ–¹æ³•:**
          1. ä¸‹è½½ SkyMenus.dylib
          2. ä½¿ç”¨å…¨èƒ½ç­¾æ³¨å…¥åˆ°æ¸¸æˆ IPA
          3. è¯¦è§é¡¹ç›® README
          
          **ç¼–è¯‘ä¿¡æ¯:**
          - æäº¤: ${{ github.sha }}
          - æ—¶é—´: ${{ github.event.head_commit.timestamp }}
          - æ¶æ„: arm64
          - iOS æœ€ä½ç‰ˆæœ¬: 10.0
        files: |
          SkyMenus.dylib
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: âœ… å®Œæˆ
      run: |
        echo ""
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘         ç¼–è¯‘æˆåŠŸå®Œæˆï¼                 â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "ğŸ“¥ ä¸‹è½½æ–¹å¼:"
        echo "  1. ç‚¹å‡» Actions æ ‡ç­¾"
        echo "  2. é€‰æ‹©è¿™æ¬¡è¿è¡Œ"
        echo "  3. ä¸‹è½½ Artifacts"
        echo ""
